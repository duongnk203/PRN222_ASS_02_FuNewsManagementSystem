@page
@using System.Security.Claims
@model FUNewsManagementSystem.Pages_NewsAriticles.DetailsModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor


@{
    ViewData["Title"] = "News Article Management";
    var roleClaim = User.FindFirst(ClaimTypes.Role);
    int role = (roleClaim == null || string.IsNullOrEmpty(roleClaim.Value)) ? 0 : int.TryParse(roleClaim.Value, out var parsedRole) ? parsedRole : 0;
    Layout = role switch
    {
        1 => "~/Pages/Shared/_LayoutStaff.cshtml",
        2 => "~/Pages/Shared/_LayoutLecturer.cshtml",
        3 => "~/Pages/Shared/_LayoutAdmin.cshtml",
        _ => "~/Pages/Shared/_LayoutGuest.cshtml"
    };
}

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/NewsArticles">News</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.NewsArticle.NewsTitle</li>
        </ol>
    </nav>

    <h1 class="text-primary fw-bold">@Model.NewsArticle.NewsTitle</h1>
    <p class="text-muted">@Model.NewsArticle.CreatedDate | By @Model.NewsArticle.CreatedBy?.AccountName</p>

    @*     @if (!string.IsNullOrEmpty(Model.NewsArticle.ImageUrl))
    {
        <img src="@Model.NewsArticle.ImageUrl" class="img-fluid w-100 rounded" alt="@Model.NewsArticle.NewsTitle">
    } *@

    <h4 class="mt-3 text-secondary">@Model.NewsArticle.Headline</h4>
    <div class="mt-3 fs-5" style="line-height: 1.8;">
        @Html.Raw(Model.NewsArticle.NewsContent)
    </div>

    <div class="mt-4 text-muted">
        <small>Source: @Model.NewsArticle.NewsSource | Category: @Model.NewsArticle.Category?.CategoryName</small>
    </div>

    <div class="mt-4 d-flex gap-2">
        <a href="https://www.facebook.com/sharer/sharer.php?u=@Url.PageLink()" target="_blank" class="btn btn-primary btn-sm">Share on Facebook</a>
        <a href="https://twitter.com/intent/tweet?url=@Url.PageLink()&text=@Model.NewsArticle.NewsTitle" target="_blank" class="btn btn-info btn-sm">Share on Twitter</a>
    </div>

    <div class="mt-4">
        <a asp-page="./Index" class="btn btn-outline-secondary">Back to News</a>
    </div>
</div>
<input type="hidden" id="newsArticleId" value="@Model.NewsArticleId" />

<h3 class="mt-5 fw-bold">√ù ki·∫øn (<span id="commentCount">@Model.Comments.Count</span>)</h3>

<!-- H·ªôp nh·∫≠p b√¨nh lu·∫≠n -->
<div class="comment-box p-3 mb-3 shadow-sm border rounded-3">
    <form id="commentForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="NewsArticleId" id="NewsArticleId" value="@Model.NewsArticle.NewsArticleId" />
        <textarea name="content" id="commentContent" class="form-control border-0" rows="3" placeholder="Chia s·∫ª √Ω ki·∫øn c·ªßa b·∫°n..." required></textarea>
        <div class="text-danger mt-1 d-none" id="commentError">B·∫°n ch∆∞a nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n.</div>
        <button type="submit" class="btn btn-primary mt-2">G·ª≠i b√¨nh lu·∫≠n</button>
    </form>
</div>

@* <!-- Tab Quan t√¢m nh·∫•t / M·ªõi nh·∫•t -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link active" href="#">Quan t√¢m nh·∫•t</a>
    </li>
</ul> *@

<!-- Danh s√°ch b√¨nh lu·∫≠n -->
<div id="commentList" class="comment-list-container"></div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/microsoft/signalr/dist/browser/signalr.js"></script>
<script src="~/js/site.js"></script>


<style>
    .comment-list-container {
        max-height: 400px; /* Gi·ªõi h·∫°n chi·ªÅu cao, c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh */
        overflow-y: auto; /* T·∫°o thanh cu·ªôn d·ªçc khi n·ªôi dung v∆∞·ª£t qu√° chi·ªÅu cao */
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 5px;
    }

    .comment-list-container {
        max-height: 50vh;
        overflow-y: auto;
    }
    /* Avatar tr√≤n */
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    /* N√∫t th√≠ch v√† tr·∫£ l·ªùi */
    .btn-link {
        text-decoration: none;
        font-size: 0.9rem;
    }

        .btn-link:hover {
            text-decoration: underline;
        }
</style>

<script>
    var newsArticleId = "@Model.NewsArticle.NewsArticleId";

    // X·ª≠ l√Ω s·ª± ki·ªán g·ª≠i b√¨nh lu·∫≠n
    $("#commentForm").submit(function (event) {
        event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa form

        let content = $("#commentContent").val().trim();
        if (!content) {
            $("#commentError").removeClass("d-none");
            return;
        } else {
            $("#commentError").addClass("d-none");
        }

        let isAuthenticated = "@User.Identity.IsAuthenticated".toLowerCase() === "true"; // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p

        if (!isAuthenticated) {
            if (confirm("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n. B·∫°n c√≥ mu·ªën ƒëƒÉng nh·∫≠p ngay kh√¥ng?")) {
                window.location.href = "/Authentication"; // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p
            }
            return; // D·ª´ng x·ª≠ l√Ω g·ª≠i b√¨nh lu·∫≠n n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
        }

        $.ajax({
            url: "/api/Comments/Create",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                newsArticleId: newsArticleId,
                content: content
            }),
            success: function () {
                $("#commentContent").val(""); // X√≥a n·ªôi dung √¥ nh·∫≠p
                console.log("‚úÖ B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i!");
            },
            error: function (xhr) {
                console.error("‚ùå L·ªói khi g·ª≠i b√¨nh lu·∫≠n:", xhr.status, xhr.statusText, xhr.responseText);
                alert("L·ªói: " + xhr.responseText);
            }
        });
    });


    // X·ª≠ l√Ω khi nh·∫•n n√∫t "S·ª≠a"
    function editComment(commentId) {
        let contentElement = $(`#commentContent_${commentId}`);
        let currentContent = contentElement.text().trim();

        // Hi·ªÉn th·ªã √¥ nh·∫≠p ƒë·ªÉ ch·ªânh s·ª≠a
        let inputField = `<input type="text" class="form-control" id="editInput_${commentId}" value="${currentContent}">`;
        let saveButton = `<button class="btn btn-sm btn-success mt-1" onclick="saveComment(${commentId})">üíæ L∆∞u</button>`;

        contentElement.html(inputField + saveButton);
    }

    // X·ª≠ l√Ω khi nh·∫•n "L∆∞u" sau khi s·ª≠a
    function saveComment(commentId) {
        let newContent = $(`#editInput_${commentId}`).val().trim();

        if (newContent === "") {
            alert("N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
            return;
        }

        $.ajax({
            url: `/api/Comments/UpdateComment`,
            method: "Post",
            contentType: "application/json",
            data: JSON.stringify({ commentId : commentId, content: newContent }),
            success: () => {
                console.log("‚úÖ B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!");
                $(`#commentContent_${commentId}`).html(newContent);
            },
            error: (xhr) => {
                console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t b√¨nh lu·∫≠n:", xhr.responseText);
                alert("L·ªói khi c·∫≠p nh·∫≠t b√¨nh lu·∫≠n!");
            }
        });
    }

    // X·ª≠ l√Ω khi nh·∫•n "X√≥a"
    function deleteComment(commentId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?")) return;

        $.ajax({
            url: `/api/Comments/Delete/${commentId}`,
            method: "DELETE",

            success: () => {
                console.log("‚úÖ B√¨nh lu·∫≠n ƒë√£ b·ªã x√≥a!");
            },
            error: (xhr) => {
                console.error("‚ùå L·ªói khi x√≥a b√¨nh lu·∫≠n:", xhr.responseText);
                alert("L·ªói khi x√≥a b√¨nh lu·∫≠n!");
            }
        });
    }
</script>
